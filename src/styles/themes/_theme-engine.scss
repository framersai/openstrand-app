@use 'sass:math';

// Theme Engine - Core theming system for multiple themes with light/dark modes
// Supports: Modern, Classic, Vintage, Paper, Cyberpunk, Minimal themes

// Utility: determine readable foreground color for a given background
@function theme-contrast($color, $light: #ffffff, $dark: #000000) {
  @if (type-of($color) != 'color') {
    @return $dark;
  }

  @if (lightness($color) > 55) {
    @return $dark;
  }

  @return $light;
}

// Utility: convert a color to an HSL string compatible with Tailwind hsl(var(--token))
@function color-to-hsl-string($color) {
  @if (type-of($color) != 'color') {
    @return $color;
  }

  $hue-value: math.round(math.div(hue($color), 1deg));
  $saturation-value: math.round(math.div(saturation($color), 1%));
  $lightness-value: math.round(math.div(lightness($color), 1%));

  @return unquote("#{$hue-value} #{$saturation-value}% #{$lightness-value}%");
}

// Theme configuration mixin
@mixin define-theme(
  $name,
  // Core colors
  $primary,
  $primary-light,
  $primary-dark,
  $secondary,
  $secondary-light,
  $secondary-dark,
  $tertiary,
  $accent,
  $accent-light,
  $accent-dark,
  // Backgrounds
  $background,
  $background-secondary,
  $background-tertiary,
  $surface,
  $surface-hover,
  // Text colors
  $text-primary,
  $text-secondary,
  $text-muted,
  $text-inverse,
  // UI elements
  $border-color,
  $border-light,
  $border-heavy,
  // Semantic colors
  $success,
  $warning,
  $error,
  $info,
  // Shadows
  $shadow-small,
  $shadow-medium,
  $shadow-large,
  $shadow-color,
  // Additional properties
  $radius-small: 4px,
  $radius-medium: 8px,
  $radius-large: 16px,
  $radius-full: 9999px,
  $font-family-base: 'Inter',
  $font-family-heading: 'Inter',
  $font-family-mono: 'Fira Code',
  $transition-base: 200ms,
  $transition-slow: 400ms,
  $blur-strength: 12px
) {
  $primary-contrast: theme-contrast($primary);
  $secondary-contrast: theme-contrast($secondary);
  $tertiary-contrast: theme-contrast($tertiary);
  $accent-contrast: theme-contrast($accent);
  $surface-contrast: theme-contrast($surface);
  $background-contrast: theme-contrast($background);
  $background-secondary-contrast: theme-contrast($background-secondary);
  $background-tertiary-contrast: theme-contrast($background-tertiary);
  $success-contrast: theme-contrast($success);
  $warning-contrast: theme-contrast($warning);
  $error-contrast: theme-contrast($error);
  $info-contrast: theme-contrast($info);

  [data-theme='#{$name}'] {
    // Color palette
    --color-primary: #{$primary};
    --color-primary-light: #{$primary-light};
    --color-primary-dark: #{$primary-dark};
    --color-secondary: #{$secondary};
    --color-secondary-light: #{$secondary-light};
    --color-secondary-dark: #{$secondary-dark};
    --color-tertiary: #{$tertiary};
    --color-accent: #{$accent};
    --color-accent-light: #{$accent-light};
    --color-accent-dark: #{$accent-dark};

    // Backgrounds
    --bg-primary: #{$background};
    --bg-secondary: #{$background-secondary};
    --bg-tertiary: #{$background-tertiary};
    --bg-surface: #{$surface};
    --bg-surface-hover: #{$surface-hover};

    // Derived foreground helpers for backgrounds
    --text-on-primary: #{theme-contrast($primary)};
    --text-on-secondary: #{theme-contrast($secondary)};
    --text-on-tertiary: #{theme-contrast($tertiary)};
    --text-on-accent: #{theme-contrast($accent)};
    --text-on-surface: #{theme-contrast($surface)};
    --text-on-surface-hover: #{theme-contrast($surface-hover)};
    --text-on-background: #{theme-contrast($background)};
    --text-on-background-secondary: #{theme-contrast($background-secondary)};
    --text-on-background-tertiary: #{theme-contrast($background-tertiary)};

    // Text colors
    --text-primary: #{$text-primary};
    --text-secondary: #{$text-secondary};
    --text-muted: #{$text-muted};
    --text-inverse: #{$text-inverse};

    // Borders
    --border-color: #{$border-color};
    --border-light: #{$border-light};
    --border-heavy: #{$border-heavy};

    // Semantic colors
    --color-success: #{$success};
    --color-warning: #{$warning};
    --color-error: #{$error};
    --color-info: #{$info};
    --text-on-success: #{$success-contrast};
    --text-on-warning: #{$warning-contrast};
    --text-on-error: #{$error-contrast};
    --text-on-info: #{$info-contrast};

    // Shadows
    --shadow-sm: #{$shadow-small};
    --shadow-md: #{$shadow-medium};
    --shadow-lg: #{$shadow-large};
    --shadow-color: #{$shadow-color};

    // Border radius
    --radius-sm: #{$radius-small};
    --radius-md: #{$radius-medium};
    --radius-lg: #{$radius-large};
    --radius-full: #{$radius-full};

    // Typography
    --font-base: #{$font-family-base}, -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
    --font-heading: #{$font-family-heading}, -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
    --font-mono: #{$font-family-mono}, 'Courier New', monospace;

    // Transitions
    --transition-base: #{$transition-base} ease;
    --transition-slow: #{$transition-slow} ease-out;

    // Effects
    --blur-strength: #{$blur-strength};

    // Gradients
    --gradient-primary: linear-gradient(135deg, var(--color-primary), var(--color-primary-dark));
    --gradient-secondary: linear-gradient(135deg, var(--color-secondary), var(--color-secondary-dark));
    --gradient-accent: linear-gradient(135deg, var(--color-accent), var(--color-accent-dark));
    --gradient-surface: linear-gradient(180deg, var(--bg-surface), var(--bg-secondary));

    // Component-specific variables
    --button-primary-bg: var(--color-primary);
    --button-primary-hover: var(--color-primary-dark);
    --button-secondary-bg: var(--color-secondary);
    --button-secondary-hover: var(--color-secondary-dark);

    --card-bg: var(--bg-surface);
    --card-border: var(--border-color);
    --card-shadow: var(--shadow-sm);

    --input-bg: var(--bg-primary);
    --input-border: var(--border-color);
    --input-focus-border: var(--color-primary);
    --input-text: var(--text-primary);

    --nav-bg: var(--bg-surface);
    --nav-text: var(--text-secondary);
    --nav-hover: var(--color-primary);

    --tooltip-bg: var(--bg-tertiary);
    --tooltip-text: var(--text-primary);

    // Chart colors
    --chart-color-1: var(--color-primary);
    --chart-color-2: var(--color-secondary);
    --chart-color-3: var(--color-accent);
    --chart-color-4: var(--color-tertiary);
    --chart-color-5: var(--color-primary-light);
    --chart-color-6: var(--color-secondary-light);
    --chart-grid: var(--border-light);

    // Tailwind CSS token alignment
    --background: #{color-to-hsl-string($background)};
    --foreground: #{color-to-hsl-string($text-primary)};
    --card: #{color-to-hsl-string($surface)};
    --card-foreground: #{color-to-hsl-string($surface-contrast)};
    --popover: #{color-to-hsl-string($surface)};
    --popover-foreground: #{color-to-hsl-string($surface-contrast)};
    --primary: #{color-to-hsl-string($primary)};
    --primary-foreground: #{color-to-hsl-string($primary-contrast)};
    --secondary: #{color-to-hsl-string($secondary)};
    --secondary-foreground: #{color-to-hsl-string($secondary-contrast)};
    --muted: #{color-to-hsl-string($background-secondary)};
    --muted-foreground: #{color-to-hsl-string($text-muted)};
    --accent: #{color-to-hsl-string($accent)};
    --accent-foreground: #{color-to-hsl-string($accent-contrast)};
    --destructive: #{color-to-hsl-string($error)};
    --destructive-foreground: #{color-to-hsl-string($error-contrast)};
    --border: #{color-to-hsl-string($border-color)};
    --input: #{color-to-hsl-string($border-color)};
    --ring: #{color-to-hsl-string($primary)};
    --radius: #{$radius-medium};
  }
}

// Dark mode variant mixin
@mixin define-dark-variant(
  $name,
  $overrides: ()
) {
  [data-theme='#{$name}'].dark,
  [data-theme='#{$name}'][data-mode='dark'] {
    @each $property, $value in $overrides {
      --#{$property}: #{$value};
    }

    // Recalculate derived contrasts when backgrounds change in dark variant
    @if map-has-key($overrides, 'bg-primary') {
      --text-on-background: #{theme-contrast(map-get($overrides, 'bg-primary'))};
    }
    @if map-has-key($overrides, 'bg-secondary') {
      --text-on-background-secondary: #{theme-contrast(map-get($overrides, 'bg-secondary'))};
    }
    @if map-has-key($overrides, 'bg-tertiary') {
      --text-on-background-tertiary: #{theme-contrast(map-get($overrides, 'bg-tertiary'))};
    }
    @if map-has-key($overrides, 'bg-surface') {
      --text-on-surface: #{theme-contrast(map-get($overrides, 'bg-surface'))};
    }
    @if map-has-key($overrides, 'bg-surface-hover') {
      --text-on-surface-hover: #{theme-contrast(map-get($overrides, 'bg-surface-hover'))};
    }
    @if map-has-key($overrides, 'color-primary') {
      --text-on-primary: #{theme-contrast(map-get($overrides, 'color-primary'))};
    }
    @if map-has-key($overrides, 'color-secondary') {
      --text-on-secondary: #{theme-contrast(map-get($overrides, 'color-secondary'))};
    }
    @if map-has-key($overrides, 'color-accent') {
      --text-on-accent: #{theme-contrast(map-get($overrides, 'color-accent'))};
    }

    // Update Tailwind token aliases when overrides include mapped values
    @if map-has-key($overrides, 'bg-primary') {
      $bg-primary: map-get($overrides, 'bg-primary');
      --background: #{color-to-hsl-string($bg-primary)};
    }
    @if map-has-key($overrides, 'text-primary') {
      $text-primary: map-get($overrides, 'text-primary');
      --foreground: #{color-to-hsl-string($text-primary)};
    }
    @if map-has-key($overrides, 'bg-surface') {
      $surface: map-get($overrides, 'bg-surface');
      --card: #{color-to-hsl-string($surface)};
      --popover: #{color-to-hsl-string($surface)};
      $surface-contrast: theme-contrast($surface);
      --card-foreground: #{color-to-hsl-string($surface-contrast)};
      --popover-foreground: #{color-to-hsl-string($surface-contrast)};
    }
    @if map-has-key($overrides, 'bg-secondary') {
      $bg-secondary: map-get($overrides, 'bg-secondary');
      --muted: #{color-to-hsl-string($bg-secondary)};
      --text-on-background-secondary: #{theme-contrast($bg-secondary)};
    }
    @if map-has-key($overrides, 'text-muted') {
      $text-muted: map-get($overrides, 'text-muted');
      --muted-foreground: #{color-to-hsl-string($text-muted)};
    }
    @if map-has-key($overrides, 'color-primary') {
      $primary: map-get($overrides, 'color-primary');
      --primary: #{color-to-hsl-string($primary)};
      --primary-foreground: #{color-to-hsl-string(theme-contrast($primary))};
      --ring: #{color-to-hsl-string($primary)};
    }
    @if map-has-key($overrides, 'color-secondary') {
      $secondary: map-get($overrides, 'color-secondary');
      --secondary: #{color-to-hsl-string($secondary)};
      --secondary-foreground: #{color-to-hsl-string(theme-contrast($secondary))};
    }
    @if map-has-key($overrides, 'color-accent') {
      $accent: map-get($overrides, 'color-accent');
      --accent: #{color-to-hsl-string($accent)};
      --accent-foreground: #{color-to-hsl-string(theme-contrast($accent))};
    }
    @if map-has-key($overrides, 'border-color') {
      $border: map-get($overrides, 'border-color');
      --border: #{color-to-hsl-string($border)};
      --input: #{color-to-hsl-string($border)};
    }
    @if map-has-key($overrides, 'error') {
      $error: map-get($overrides, 'error');
      --destructive: #{color-to-hsl-string($error)};
      --destructive-foreground: #{color-to-hsl-string(theme-contrast($error))};
    }
  }
}

// Responsive theme adjustments
@mixin responsive-theme-adjustments() {
  @include min-width('xs') {
    :root {
      --spacing-unit: 4px;
      --font-size-base: 14px;
    }
  }

  @include min-width('sm') {
    :root {
      --spacing-unit: 4px;
      --font-size-base: 15px;
    }
  }

  @include min-width('md') {
    :root {
      --spacing-unit: 8px;
      --font-size-base: 16px;
    }
  }

  @include min-width('lg') {
    :root {
      --spacing-unit: 8px;
      --font-size-base: 16px;
    }
  }
}

// Theme transition effects
@mixin theme-transition() {
  * {
    transition:
      background-color var(--transition-base),
      border-color var(--transition-base),
      color var(--transition-base),
      fill var(--transition-base),
      stroke var(--transition-base);
  }
}

// Glass morphism effect
@mixin glassmorphism($opacity: 0.7, $blur: var(--blur-strength)) {
  background: rgba(255, 255, 255, $opacity);
  backdrop-filter: blur($blur);
  -webkit-backdrop-filter: blur($blur);
  border: 1px solid rgba(255, 255, 255, 0.2);

  @supports not (backdrop-filter: blur(10px)) {
    background: var(--bg-surface);
  }
}

// Neumorphism effect
@mixin neumorphism($distance: 6px, $blur: 12px) {
  background: var(--bg-surface);
  box-shadow:
    #{$distance} #{$distance} #{$blur} var(--shadow-color),
    -#{$distance} -#{$distance} #{$blur} rgba(255, 255, 255, 0.7);
}

// Apply theme transitions
.theme-transition {
  @include theme-transition();
}

// Apply responsive adjustments
@include responsive-theme-adjustments();
